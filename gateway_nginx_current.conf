# =======================================================
# UNIFIED GATEWAY CONFIGURATION
# =======================================================

# Upstream Definitions
# These match the service names in docker-compose.unified.yml
upstream api_backend {
    server api:9000;
}

upstream customer_frontend {
    server customer:5173;
}

upstream vendor_frontend {
    server vendor:5174;
}

upstream admin_frontend {
    server admin:5175;
}

server {
    listen 80;
    server_name local.resortwala.com;
    
    # Timeout Settings (Prevent 504 Gateway Timeouts)
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    fastcgi_read_timeout 300s;

    # Gzip Compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Health Check Endpoint
    location /health {
        access_log off;
        return 200 '{"status":"healthy","gateway":"online"}';
        add_header Content-Type application/json;
    }

    # ==================================================
    # API ROUTES
    # ==================================================
    location /api {
        alias /var/www/html/public;
        try_files $uri $uri/ @laravel;

        location ~ \.php$ {
            fastcgi_pass api_backend;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include fastcgi_params;
        }
    }

    location @laravel {
        fastcgi_pass api_backend;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        include fastcgi_params;
    }

    # ==================================================
    # STORAGE PROXY (Fall back to Beta if local missing)
    # ==================================================
    location /storage {
        alias /var/www/html/public/storage;
        try_files $uri @remote_storage;
    }

    location @remote_storage {
        resolver 8.8.8.8;
        proxy_pass https://beta.resortwala.com$uri;
        proxy_set_header Host beta.resortwala.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_ssl_server_name on;
    }

    # ==================================================
    # SUB-PANEL: VENDOR
    # ==================================================
    location /vendor {
        proxy_pass http://vendor_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (HMR)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ==================================================
    # SUB-PANEL: ADMIN
    # ==================================================
    location /admin {
        proxy_pass http://admin_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (HMR)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ==================================================
    # CUSTOMER PANEL (ROOT)
    # ==================================================
    # Must be last to catch all other traffic
    location / {
        proxy_pass http://customer_frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (HMR)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
